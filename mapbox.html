<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Mapbox demo</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id='map'></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibHBlaTc1NiIsImEiOiJjbGxoOHozODAwOHpxM2xsd2ZsM2xzOWl3In0.Gh9K818BkemD9i3PrQblrQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [172.6362, -43.5321],
            zoom: 8
        });

        map.on('load', function () {
            // Load the icons to the map
            map.loadImage('assets/Built.png', function (error, image) {
                if (error) throw error;
                map.addImage('build-icon', image);
            });

            map.loadImage('assets/Maintain.png', function (error, image) {
                if (error) throw error;
                map.addImage('maintain-icon', image);
            });

            map.loadImage('assets/Repair.png', function (error, image) {
                if (error) throw error;
                map.addImage('repair-icon', image);
            });

            // Fetch data from christchurchplaces.json
            fetch('christchurchplaces.json')
                .then(response => response.json())
                .then(data => {
                    // Convert data to GeoJSON format
                    var geojsonData = {
                        type: 'FeatureCollection',
                        features: []
                    };

                    data.forEach(function (item) {
                        geojsonData.features.push({
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [item.longitude, item.latitude]
                            },
                            properties: item
                        });
                    });

                    // Add the GeoJSON data source to the map
                    map.addSource('places', {
                        type: 'geojson',
                        data: geojsonData
                    });

                    map.addLayer({
                        'id': 'places-points',
                        'type': 'symbol',
                        'source': 'places',
                        'layout': {
                            'icon-image': ['match', ['get', 'category'],
                                'Build', 'build-icon',
                                'Maintain', 'maintain-icon',
                                'Repair', 'repair-icon',
                                'default-icon'  // Default icon if category does not match any given value
                            ],
                            'icon-size': 0.08  // Size of the icon
                        }
                    });

                    // Display a popup on click
                    map.on('click', 'places-points', function (e) {
                        var feature = e.features[0];
                        var popup = new mapboxgl.Popup()
                            .setLngLat(feature.geometry.coordinates)
                            .setHTML('<strong>' + feature.properties.place_name + '</strong><br>' +
                                feature.properties.address + '<br>' +
                                'Category: ' + feature.properties.category + '<br>' +
                                'Contact: ' + feature.properties.point_of_contact + '<br>' +
                                'Urgency: ' + feature.properties.urgency + '<br>' +
                                'Sentiment: ' + feature.properties.sentiment)
                            .addTo(map);
                    });
                });
        });


    </script>
</body>

</html>